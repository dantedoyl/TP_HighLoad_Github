# TP_HighLoad_Github
## 1. Тема и целевая аудитори
### Тема
GitHub - это система управления проектами и версиями кода, а также платформа социальных сетей, созданная для разработчиков.
### Функционал MVP
- Флоу Авторизации
- Работа с репозиторием (создание/хранение/скачивание/внесение изменений)
- Работа с Pull Request (создание/получение)
- Работа с Issues (создание/получение)
- Работа с комментариями в пулл реквестах и ищьюсах (создание/получение)

### Целевая аудитория
По информации из официальныз отчетов возьмем `количество пользователей = 70+ миллионов`

Возьмем, что из этого количества 
На ноябрь 2018 в Github было создано 100m репозиториев. С учетом, что суммарно за период 2018-2020 годы количество репозиториев выросло еще на 100m (2019 - +40m; 2020 - +60m), возьмем, что в данный момент `количество репозиториев = 250+ миллионов`

#### Географическое распределение
- Северная Америка - 35%
- Азия - 30%
- Европа - 25%
- Остальной - 10%

## 2. Расчёт нагрузки
### Продуктовые метрики
По данным на 2015 год ежемесечное количество пользователей - 32m человек. На то время а количество пользователей было примерно 5m.
Тогда при нынешней аудитории в 70m+ человек предположим, что `ежемесечное количество пользователей = 600m.`
А `ежедневное количество активных юзеров` возьмем равным `~30+ миллионов человек`.

Предположим, что в среднем у одного пользователя ~5 репозиториев. Репозитории привышающие по размеру 50Мб встречаются редко, поэтому возьмем, что в среднем максимальный размер репозитория равен ~40Мб, причем у одного пользователя такий репозиториев не больше одного. Оставшиеся репозитории имеют размер не привышающий ~2МБ.
Тогда средний `размер одного репозитория возьмем равным ~10 Мб`

К тому же в одном репозитории есть примерно:
- `5 Pull Request ~ 100 Байт`\
Из 70+m пользователей 70% создает Pull Request'ы на 50% существующих репозиториев. Из личного опыта коллег и моего решил взять, что один пользователь создает 1 Pull Request в неделю. Тогда (70 * 1000000 * 0,7 * 48) / (250 * 1000000 * 0,5) = 4,7 ~ 5 
- `4 Issues ~ 512 Байт (Размер текста одного issue ~ 128 Байт)`\
Из 70+m пользователей 30% создает Issues'ы на 50% существующих репозиториев. Из личного опыта коллег и моего решил взять, что один пользователь создает 2 Issues в месяц. Тогда (70 * 1000000 * 0,3 * 24) / (250 * 1000000 * 0,5) = 4 
- `10 комментариев к Pull Request'ам и issues'ам ~ 650 Байт` (Возьмём среднюю длину комментария в 65 символов)

Также положим, что 60% пользователей имеют аватарку в профиле и ее размер ~0.5Мб.

Тогда получается, что `Средний размер хранилища пользователя = ~50.5 МБ`

#### Среднее количество действий пользователя по типам за период.
*`Данные взяты из личного опыта и опыта коллег`*

| Вид действия                                                 | Количество/Период |
| ------------------------------------------------------------ | ----------------- |
| Создание репозитория                                         |     2 в месяц     |
| Скачивание репозитория (git clone)                           |     4 в месяц     |
| Скачать новые данные из репозитория (git pull)               |     3 в день      |
| Добавление изменений в репозиторий (git commit/git push)     |     5 в день      |
| Создание issue                                               |     2 в месяц     |
| Получение issue                                              |     1 в неделю    |
| Добавление комментария                                       |     2 в день      |
| Получение комментариев                                       |     2 в день      |
| Создание Pull Request                                        |     1 в неделю    |
| Получение Pull request                                       |     1 в день      |


### Технические метрики
#### Размер хранения в разбивке по типам данных
1. Репозиториии = 250 000 000 * 10 Мб = 2 384,2 Тб
2. Issues = 250 000 000 * 4 * 128 Байт = 119,2 Гб
3. Комментарии = 250 000 000 * 10 * 65 Байт = 151,3 Гб
4. Pull Requests = 250 000 000 * 5 * 20 Байт = 23,3 Гб
5. Фотографии пользователей = 70 000 000 * 0,6 * 0.5 Кб = 20 Гб

#### Сетевой трафик и RPS
```
Коэффициент перевода действий пользователя за период в RPS:
r = 30 000 000 / 24 * 60 * 60 = 347,22 людей/сек
```

1. Создание репозитория

| Метод  | Transfered over network, Кб | RPS                    | Трафик       |
| ------ | --------------------------- | ---------------------- | ------------ |
| POST   | 3,9                         | 2 * r / 30 = `23,1`    | 90,1 Kб/с    |

2. Скачивание репозитория (git clone) 

Проверка авторизации
| Метод  | Transfered over network, Кб | RPS                    | Трафик       |
| ------ | --------------------------- | ---------------------- | ------------ |
| GET    | 0,16                        | 4 * r / 30 = `46,3`    | 7,4 Kб/с     |

Получение мета-данных
| Метод  | Transfered over network, Кб | RPS                    | Трафик       |
| ------ | --------------------------- | ---------------------- | ------------ |
| GET    | 0,3                         | 4 * r / 30 = `46,3`    | 13,9 Kб/с    |

Скачивание репозитория
| Метод  | Transfered over network, Кб | RPS                    | Трафик       |
| ------ | --------------------------- | ---------------------- | ------------ |
| GET    | 10240                       | 4 * r / 30 = `46,3`    | 463 Мб/с     |

3. Скачать новые данные из репозитория (git pull)

Проверка авторизации
| Метод  | Transfered over network, Кб | RPS                    | Трафик       |
| ------ | --------------------------- | ---------------------- | ------------ |
| GET    | 0,16                        | 3 * r = `1041,6`       | 166,7 Kб/с   |

Получение мета-данных
| Метод  | Transfered over network, Кб | RPS                    | Трафик       |
| ------ | --------------------------- | ---------------------- | ------------ |
| GET    | 0,3                         | 3 * r = `1041,6`       | 312,5 Kб/с   |

Скачать новые данные из репозитория
| Метод  | Transfered over network, Кб | RPS                    | Трафик       |
| ------ | --------------------------- | ---------------------- | ------------ |
| GET    | 3,3                         | 3 * r = `1041,6`       | 3,3 Мб/с     |

4. Добавление изменений в репозиторий (git commit/git push)

Проверка авторизации
| Метод  | Transfered over network, Кб | RPS                    | Трафик       |
| ------ | --------------------------- | ---------------------- | ------------ |
| GET    | 0,16                        | 5 * r = `1736`         | 277,8 Kб/с   |

Отправка мета-данных
| Метод  | Transfered over network, Кб | RPS                    | Трафик       |
| ------ | --------------------------- | ---------------------- | ------------ |
| POST   | 0,3                         | 5 * r = `1736`         | 520,8 Kб/с   |

Скачать новые данные из репозитория
| Метод  | Transfered over network, Кб | RPS                    | Трафик       |
| ------ | --------------------------- | ---------------------- | ------------ |
| POST   | 3,3                         | 5 * r = `1736`         | 5,6 Мб/с     |

5. Создание issue

| Метод  | Transfered over network, Kб | RPS                    | Трафик       |
| ------ | --------------------------- | ---------------------- | ------------ |
| POST   | 3,4                         | 2 * r / 30 = `23,1`    | 78,5 Kб/с    |

6. Получение issues

| Метод  | Transfered over network, Kб | RPS                    | Трафик       |
| ------ | --------------------------- | ---------------------- | ------------ |
| GET    | 36,4                        | 2 * r / 7 = `99,2`     | 3,5 Mб/с     |

7. Добавление комментария

| Метод  | Transfered over network, Kб | RPS                    | Трафик       |
| ------ | --------------------------- | ---------------------- | ------------ |
| POST   | 18,9                        | 2 * r = `694,4`        | 12,8 Mб/с    |

8. Получение комментариев

| Метод  | Transfered over network, Kб | RPS                    | Трафик       |
| ------ | --------------------------- | ---------------------- | ------------ |
| GET    | 95,5                        | 2 * r = `694,4`        | 64,8 Mб/с    |

9. Создание Pull Request

| Метод  | Transfered over network, Kб | RPS                    | Трафик       |
| ------ | --------------------------- | ---------------------- | ------------ |
| POST   | 3,4                         | r / 7 = `49,6`         | 168,6 Kб/с   |

10. Получение Pull request

| Метод  | Transfered over network, Kб | RPS                    | Трафик       |
| ------ | --------------------------- | ---------------------- | ------------ |
| GET    | 46,6                        | r  = `347,2`           | 15,8 Мб/с    |

##### Итог
| Вид действия                                                 | RPS               |  Трафик        |
| ------------------------------------------------------------ | ----------------- | -------------- |
| Проверка авторизации                                         |     2823,9        | 451,9 Кб/с     |
| Получение мета-данных                                        |     1087,9        | 326,38 Кб/с    |
| Отправка мета-данных                                         |     1736          | 520,8 Кб/с     |
| Создание репозитория                                         |     23,1          | 90,1 Kб/с      |
| Скачивание репозитория (git clone)                           |     46,3          | 463 Мб/с       |
| Скачать новые данные из репозитория (git pull)               |     1041,6        | 3,3 Мб/с       |
| Добавление изменений в репозиторий (git commit/git push)     |     1736          | 5,6 Мб/с       |
| Создание issue                                               |     23,1          | 78,5 Kб/с      |
| Получение issues                                             |     99,2          | 3,5 Mб/с       |
| Добавление комментария                                       |     694,4         | 12,8 Mб/с      |
| Получение комментариев                                       |     694,4         | 64,8 Mб/с      |
| Создание Pull Request                                        |     49,6          | 168,6 Kб/с     |
| Получение Pull request                                       |     347,2         | 15,8 Мб/с      |
|                                                              |                   |                |
| **Общие значения**                                           | `10401,7`         | `0,56 Гб/с`    |
| **При пиковой нагрузке возьмем x3**                          | `31205,1`         | `1,68 Гб/с`    |

## Базы данных
### Логическая схема
![logical](/img/logical.png)
### Физическая схема
![physical](/img/physical.png)

### Шардирование
- **PostgreSQL Repos** - шардирование по `user_id`
- **PostgreSQL PRs** - шардирование по `(repo_id, pull_request_id)`
- **PostgreSQL Issues** - шардирование по `(repo_id, issue_id)`
- **MinIO** - шардирование по `repo_id`
- **Ceph** - шардирование по `user_id`

### Рассчет размера
#### PostgreSQL
| Таблица       | Значение                                                     | Итог         |
| ------------- | ------------------------------------------------------------ | ------------ |
| Users         | (8 + 64 + 64 + 256) байт * 70 000 000 человек                | 25.5 Гб      |
| Repositories  | (8 + 8 + 256 + 4) байт * 250 000 000 репозиториев            | 64.2 Гб      |
| Pull Requests | (8 + 8 + 8 + 4) байт * 30 000 000 человек * 48 раз в год     | 37,5 Гб/год  |
| Issues        | (8 + 8 + 8 + 256) байт * 30 000 000 человек * 24 раз в год   | 187,7 Гб/год |
| Comments (все)| (8 + 8 + 8 + 256) байт * 30 000 000 человек * 730 раз в год  | 5,5 Тб/год   |

#### MinIO
| Таблица       | Значение                                                     | Итог         |
| ------------- | ------------------------------------------------------------ | ------------ |
| Packfiles     | 10 Mb * 250 000 000 репозиториев                             | 2,3 Пб       |

#### Ceph
| Таблица       | Значение                                                     | Итог         |
| ------------- | ------------------------------------------------------------ | ------------ |
| Аватарки      | 70 000 000 человек * 0,6 * 0.5 Кб                            | 20 Гб        |

## Технологии
### Клиент
- В выборе технологий для фронта будем отталкиватся от знаний разработчиков в нашей команде.
- Для раздачи фронтенда будем использовать `CDN` для уменьшения задержки.
- Для разрешения доменных имён (domain name resolving) возьмем высокодоступный DNS сервис, к примеру `Amazon Route 53`
- Также для фильтрации трафика и предотвращения высоких нагрузок и DDoS атак добавим еще сервис-firewall `CloudFlare`

### Балансировка
- Будем использовать `Round Robin` у DNS, тем самым будем равномерно распределять нагрузку на наши вебсервера Nginx.
- Для балансировки на уровне Nginx будем использовать L7 балансировку

### 

### Хранилища
- Для хранения большинства данных будем использовать реляционную СУБД PostgreSQL, она обладает высокой надежностью и ее будет достаточно для создания новых в ней данных
- Для ускорения записи применим шардирование, чтобы выдерживать нагрузку на запись
- Кроме того для хранения объектов (packfiles и аватарок) будем использовать объектные хранилища: Ceph для аватарок и MinIO для packfiles
- Ceph - бесплатная распределенная файловая система с открытым исходным кодом, лишенная узких мест и единых точек отказа, которая представляет из себя легко масштабируемый кластер узлов
- MinIO также объектное хранилище, но имеет ряд приемуществ, к примеру совместимость с Amazon S3 API и размером хранимых данных до 5 ТБ. К тому же этот инструмент используется GitLab'ом. К сожалению, это хранилище платное, поэтому было решено для аватарок использовать бесплатное решение. 
- Для репликации в Postgres будем использовать `patroni`

## Архитектура

## Сервера
### Расположение
С учетом географического распределения аудитории сервера расположим так:
![map](/img/map.jpg)

## Используемые источники
- https://octoverse.github.com/
- https://octoverse.github.com/2019/
- https://github.blog/2018-11-08-100M-repos/
- https://venturebeat.com/2015/06/17/github-by-the-numbers-32m-people-visit-each-month-74-from-outside-the-u-s-36-from-europe/
- https://github.blog/2009-10-20-how-we-made-github-fast/
- https://about.gitlab.com/handbook/engineering/infrastructure/production/architecture/
